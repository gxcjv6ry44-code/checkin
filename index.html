<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orchard Check-In</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7f9;padding:20px}
    .card{max-width:720px;margin:0 auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .ok{color:#166534;font-weight:800}
    .bad{color:#b91c1c;font-weight:800}
    .muted{color:#6b7280;font-size:13px}
    code{background:#f3f4f6;padding:2px 6px;border-radius:6px}
    .row{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{padding:11px 14px;border-radius:12px;border:0;font-weight:800;cursor:pointer}
    button.primary{background:#2563eb;color:#fff}
    button.secondary{background:#e5e7eb;color:#111827}
    .box{margin-top:14px;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fbfbfc}
    .checkRow{display:flex;gap:10px;align-items:flex-start}
    .checkRow input{margin-top:3px;width:18px;height:18px}
  </style>
</head>
<body>
  <div class="card">
    <h2>North Ogden Orchard Check-In</h2>

    <div id="status" class="muted">Preparing check-in…</div>
    <div id="detail" class="muted" style="margin-top:10px;"></div>

    <div id="actions" style="display:none;">
      <div class="box">
        <div class="checkRow">
          <input id="watchedSafetyVideos" type="checkbox" />
          <div>
            <div style="font-weight:800;">Safety training (optional)</div>
            <div class="muted">
              Check this box if you have already watched the orchard safety videos.
              (This does not block check-in.)
            </div>
          </div>
        </div>

        <div class="row">
          <button id="confirmBtn" class="primary">Confirm Check-In</button>
          <button id="retryGeoBtn" class="secondary" type="button">Retry Location</button>
        </div>

        <div class="muted" style="margin-top:8px;">
          If location fails, make sure your phone allows location for this site and try again.
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const MAKE_CHECKIN_WEBHOOK_URL = "https://hook.us2.make.com/5vsa578e34v4xr5u3yh7dlqgghvqifyb";

    // Hard geofence (edit these as needed)
    const GEOFENCE_CENTER_LAT = 41.3275;
    const GEOFENCE_CENTER_LNG = -112.0101;
    const GEOFENCE_RADIUS_METERS = 200;


    const GEO_OPTS = {
      enableHighAccuracy: true,
      timeout: 30000,
      maximumAge: 60000
    };

    /***********************
     * Helpers
     ***********************/
    function qp(name) {
      return new URLSearchParams(window.location.search).get(name) || "";
    }

    function setStatus(msg, ok = true) {
      statusEl.className = ok ? "ok" : "bad";
      statusEl.textContent = msg;
    }

    function distanceMeters(lat1, lon1, lat2, lon2) {
      const toRad = (x) => (x * Math.PI) / 180;
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function getPosition() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(Object.assign(new Error("Geolocation not supported."), { code: "NO_GEO" }));
          return;
        }
        navigator.geolocation.getCurrentPosition(resolve, reject, GEO_OPTS);
      });
    }

    function renderDetail(extraHtml = "") {
      detailEl.innerHTML =
        `<div><strong>Date:</strong> <code>${payload.serviceDate || "-"}</code></div>
         <div><strong>Shift:</strong> <code>${payload.shift || "-"}</code></div>
         <div><strong>Stake:</strong> <code>${payload.stake || "-"}</code></div>
         ${extraHtml}`;
    }

    /***********************
     * Elements + payload
     ***********************/
    const statusEl = document.getElementById("status");
    const detailEl = document.getElementById("detail");
    const actionsEl = document.getElementById("actions");
    const confirmBtn = document.getElementById("confirmBtn");
    const retryGeoBtn = document.getElementById("retryGeoBtn");
    const watchedEl = document.getElementById("watchedSafetyVideos");

    const payload = {
      serviceDate: qp("date"),
      shift: qp("shift"),
      stake: qp("stake"),
      scanKey: qp("key"),
      watchedSafetyVideos: false,
      // geofence info will be added after location check
      geo: null
    };

    let geoOk = false;
    let isSubmitting = false;

    /***********************
     * Main flow
     ***********************/
    async function runGeofence() {
      setStatus("Checking location…", true);
      renderDetail();

      const pos = await getPosition();
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const accuracy = pos.coords.accuracy;

      const dist = distanceMeters(lat, lng, GEOFENCE_CENTER_LAT, GEOFENCE_CENTER_LNG);

      payload.geo = {
        lat,
        lng,
        accuracyMeters: accuracy,
        distanceMeters: dist,
        centerLat: GEOFENCE_CENTER_LAT,
        centerLng: GEOFENCE_CENTER_LNG,
        radiusMeters: GEOFENCE_RADIUS_METERS
      };

      const geoHtml =
        `<div style="margin-top:10px;">
           <strong>Location:</strong>
           <code>${Math.round(dist)}m</code> from orchard (allowed <code>${GEOFENCE_RADIUS_METERS}m</code>, accuracy ±<code>${Math.round(accuracy)}m</code>)
         </div>`;

      renderDetail(geoHtml);

      if (dist > GEOFENCE_RADIUS_METERS) {
        geoOk = false;
        setStatus("Not at orchard location — check-in blocked.", false);
        actionsEl.style.display = "none";
        return;
      }

      geoOk = true;
      setStatus("Location verified. Please confirm check-in.", true);
      actionsEl.style.display = "block";
    }

    async function submitCheckin() {
      if (isSubmitting) return;
      isSubmitting = true;
      confirmBtn.disabled = true;
      confirmBtn.textContent = "Submitting…";

      payload.watchedSafetyVideos = !!watchedEl.checked;

      try {
        const resp = await fetch(MAKE_CHECKIN_WEBHOOK_URL.trim(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await resp.text();
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch (_) {}

        if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${text}`);

        if (data.status === "duplicate") {
          setStatus("Already checked in ✓ (duplicate scan)", true);
        } else if (data.status === "ok") {
          setStatus("Checked in ✓", true);
        } else {
          setStatus("Checked in ✓ (no status returned)", true);
        }

        actionsEl.style.display = "none"; // stop double-submit
      } catch (err) {
        console.error(err);
        setStatus("Check-in failed. Please tell the orchard lead.", false);
      } finally {
        isSubmitting = false;
        confirmBtn.disabled = false;
        confirmBtn.textContent = "Confirm Check-In";
      }
    }

    // Validate required QR parameters before anything else
    const missing =
      !payload.serviceDate || !payload.shift || !payload.stake || !payload.scanKey;

    if (missing) {
      setStatus("Missing check-in info. Please re-scan your QR code.", false);
      renderDetail();
    } else if (!MAKE_CHECKIN_WEBHOOK_URL || MAKE_CHECKIN_WEBHOOK_URL.includes("PASTE_")) {
      setStatus("Check-in page is not configured (webhook missing).", false);
      renderDetail();
    } else {
      // wire buttons
      confirmBtn.addEventListener("click", () => {
        if (!geoOk) return;
        submitCheckin();
      });

      retryGeoBtn.addEventListener("click", () => runGeofence().catch(err => {
        console.error(err);
        setStatus(`Location check failed: ${err.message || err}`, false);
      }));

      // start geofence on load
      runGeofence().catch(err => {
        console.error(err);
        setStatus(`Location check failed: ${err.message || err}`, false);
        renderDetail();
        actionsEl.style.display = "none";
      });
    }
  </script>
</body>
</html>
